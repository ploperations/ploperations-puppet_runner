name: CI

on:
  - pull_request

jobs:
  setup_matrix:
    name: 'Setup Test Matrix'
    runs-on: ubuntu-latest
    timeout-minutes: 40
    outputs:
      beaker_setfiles: ${{ steps.get-outputs.outputs.beaker_setfiles }}
      puppet_major_versions: ${{ steps.get-outputs.outputs.puppet_major_versions }}
      puppet_unit_test_matrix: ${{ steps.get-outputs.outputs.puppet_unit_test_matrix }}
    steps:
      - uses: actions/checkout@v2
      - name: Install the Puppet PDK
        run: |
          CODENAME=$(grep UBUNTU_CODENAME /etc/os-release | cut -d '=' -f2)
          wget https://apt.puppet.com/puppet-tools-release-$CODENAME.deb
          sudo apt-get update
          sudo dpkg -i puppet-tools-release-$CODENAME.deb
          sudo apt-get update
          sudo apt-get install pdk
      - name: Install gems
        run: pdk bundle install
      - name: Setup Test Matrix
        id: get-outputs
        run: pdk bundle exec metadata2gha --use-fqdn --pidfile-workaround CentOS,Ubuntu
  unit:
    needs: setup_matrix
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        include: ${{fromJson(needs.setup_matrix.outputs.puppet_unit_test_matrix)}}

    name: Puppet ${{ matrix.puppet }}
    steps:
      - uses: actions/checkout@v2
      - name: Install the Puppet PDK
        run: |
          CODENAME=$(grep UBUNTU_CODENAME /etc/os-release | cut -d '=' -f2)
          wget https://apt.puppet.com/puppet-tools-release-$CODENAME.deb
          sudo apt-get update
          sudo dpkg -i puppet-tools-release-$CODENAME.deb
          sudo apt-get update
          sudo apt-get install pdk
      - name: Syntax validation
        run: pdk validate --puppet-version ${{ matrix.puppet }}
      - name: Unit tests
        run: pdk test unit --puppet-version ${{ matrix.puppet }}

  acceptance:
    needs: setup_matrix
    runs-on: ubuntu-latest
    env:
      LANG: en_US
      LC_ALL: en_US.UTF-8
    strategy:
      fail-fast: false
      matrix:
        setfile: ${{fromJson(needs.setup_matrix.outputs.beaker_setfiles)}}
        puppet: ${{fromJson(needs.setup_matrix.outputs.puppet_major_versions)}}
    name: ${{ matrix.puppet.name }} - ${{ matrix.setfile.name }}
    steps:
      - uses: actions/checkout@v2
      - name: Install the Puppet PDK
        run: |
          CODENAME=$(grep UBUNTU_CODENAME /etc/os-release | cut -d '=' -f2)
          wget https://apt.puppet.com/puppet-tools-release-$CODENAME.deb
          sudo apt-get update
          sudo dpkg -i puppet-tools-release-$CODENAME.deb
          sudo apt-get update
          sudo apt-get install pdk
      - name: Install gems
        run: pdk bundle install
      - name: Run tests
        run: pdk bundle exec rake beaker
        env:
          BEAKER_PUPPET_COLLECTION: ${{ matrix.puppet.collection }}
          BEAKER_setfile: ${{ matrix.setfile.value }}